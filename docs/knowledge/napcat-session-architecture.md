# napcat è¿æ¥ç®¡ç†æ¶æ„çŸ¥è¯†ç‚¹

## ç»Ÿä¸€è¿æ¥ç®¡ç†æ¨¡å¼

### è®¾è®¡ç†å¿µ

ç»Ÿä¸€è¿æ¥ç®¡ç†æ˜¯ä¸€ç§èµ„æºä¼˜åŒ–çš„æ¶æ„æ¨¡å¼ï¼Œä½¿ç”¨å•ä¸€çš„ WebSocket è¿æ¥æœåŠ¡æ‰€æœ‰ç¾¤ç»„ï¼Œé€šè¿‡æ¶ˆæ¯åˆ†å‘æœºåˆ¶è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å•å…ƒã€‚è¿™ç§æ¨¡å¼åœ¨ä¿æŒä¸šåŠ¡é€»è¾‘å°è£…çš„åŒæ—¶ï¼Œæ˜¾è‘—å‡å°‘äº†ç³»ç»Ÿèµ„æºæ¶ˆè€—ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

1. **èµ„æºä¼˜åŒ–**
   - å…¨å±€å”¯ä¸€ WebSocket è¿æ¥ï¼Œå‡å°‘ç½‘ç»œèµ„æºæ¶ˆè€—
   - é™ä½ç³»ç»Ÿå†…å­˜å ç”¨å’Œè¿æ¥æ•°é™åˆ¶å‹åŠ›
   - ç®€åŒ–è¿æ¥çŠ¶æ€ç®¡ç†å’Œç›‘æ§

2. **èŒè´£åˆ†ç¦»**
   - ConnectionManager ä¸“æ³¨è¿æ¥ç®¡ç†å’ŒåŸºç¡€æœåŠ¡
   - SessionManager è´Ÿè´£æ¶ˆæ¯åˆ†å‘å’Œä¼šè¯è°ƒåº¦
   - Session ä¸“æ³¨ç¾¤ç»„çº§åˆ«ä¸šåŠ¡é€»è¾‘

3. **æ‰©å±•æ€§å¼º**
   - æ”¯æŒåŠ¨æ€æ·»åŠ ç¾¤ç»„è€Œæ— éœ€åˆ›å»ºæ–°è¿æ¥
   - ä¾¿äºæœªæ¥æ”¯æŒå¤šè´¦å·æˆ–å…¶ä»–è¿æ¥ç±»å‹
   - æ¶ˆæ¯åˆ†å‘å™¨æœºåˆ¶æ”¯æŒçµæ´»çš„è·¯ç”±ç­–ç•¥

4. **å¯ç»´æŠ¤æ€§**
   - åˆ†å±‚æ¶æ„ä¾¿äºå•ç‹¬æµ‹è¯•å„ä¸ªç»„ä»¶
   - é”™è¯¯éš”ç¦»æœºåˆ¶ç¡®ä¿å±€éƒ¨é—®é¢˜ä¸å½±å“æ•´ä½“
   - ç»Ÿä¸€è¿æ¥ç®¡ç†ç®€åŒ–äº†éƒ¨ç½²å’Œè¿ç»´

## åˆ†å±‚æ¶æ„ç»„ä»¶

### ConnectionManagerï¼ˆè¿æ¥å±‚ï¼‰

- ç®¡ç†å”¯ä¸€çš„ napcat WebSocket è¿æ¥
- æä¾›æ¶ˆæ¯åˆ†å‘å™¨æ³¨å†Œæœºåˆ¶
- å°è£…åº•å±‚ API è°ƒç”¨ï¼ˆå‘é€æ¶ˆæ¯ã€è·å–ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰
- é›†ä¸­å¤„ç†è¿æ¥çŠ¶æ€å’Œé”™è¯¯

```typescript
class ConnectionManager {
    private napcat: NCWebsocket;
    private messageDispatcher?: MessageDispatcher;
    
    constructor(napcatConfig: NapcatConfig) {
        this.napcat = new NCWebsocket({
            baseUrl: napcatConfig.base_url,
            accessToken: napcatConfig.access_token,
            reconnection: napcatConfig.reconnection
        }, false);
    }
    
    setMessageDispatcher(dispatcher: MessageDispatcher): void {
        this.messageDispatcher = dispatcher;
    }
}
```

### SessionManagerï¼ˆåˆ†å‘å±‚ï¼‰

- åˆ›å»ºå’Œç®¡ç† ConnectionManager å®ä¾‹
- å®ç°æ¶ˆæ¯åˆ†å‘é€»è¾‘ï¼Œæ ¹æ® groupId è·¯ç”±æ¶ˆæ¯
- ç®¡ç†æ‰€æœ‰ Session å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ
- æä¾›ç»Ÿä¸€çš„ç®¡ç†æ¥å£

### Sessionï¼ˆä¸šåŠ¡å±‚ï¼‰

- é€šè¿‡ ConnectionManager å§”æ‰˜æ‰§è¡Œåº•å±‚æ“ä½œ
- ä¸“æ³¨ç¾¤ç»„çº§åˆ«çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
- ä¿æŒå‘åå…¼å®¹çš„å…¬å…±æ¥å£

### é”™è¯¯å¤„ç†ç­–ç•¥

- **è¿æ¥å±‚é”™è¯¯**ï¼šConnectionManager ç»Ÿä¸€å¤„ç†è¿æ¥å¤±è´¥å’Œé‡è¿
- **åˆ†å‘å±‚é”™è¯¯**ï¼šSessionManager å¤„ç†æ¶ˆæ¯è·¯ç”±é”™è¯¯ï¼Œè®°å½•å¹¶è·³è¿‡
- **ä¸šåŠ¡å±‚é”™è¯¯**ï¼šSession å¤„ç†æ¶ˆæ¯è§£æå’Œå¤„ç†é€»è¾‘é”™è¯¯ï¼Œä¸å½±å“å…¶ä»–ç¾¤ç»„
- ä¼˜é›…çš„é”™è¯¯æ—¥å¿—è®°å½•å’Œç›‘æ§

## æ¶ˆæ¯å¤„ç†æµç¨‹

### æ¥æ”¶æµç¨‹

1. **è¿æ¥å±‚æ¥æ”¶**ï¼šConnectionManager ç›‘å¬ `message.group` äº‹ä»¶
2. **æ¶ˆæ¯åˆ†å‘**ï¼šé€šè¿‡æ³¨å†Œçš„ MessageDispatcher å°†åŸå§‹æ¶ˆæ¯å‘é€ç»™ SessionManager
3. **è·¯ç”±åˆ†å‘**ï¼šSessionManager æ ¹æ® groupId å°†æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº” Session
4. **ç»“æ„åŒ–å­˜å‚¨**ï¼šSession ç›´æ¥ä¿å­˜å®Œæ•´çš„ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼ï¼Œæ— éœ€é¢å¤–è§£æ
5. **ç”¨æˆ·ä¿¡æ¯è·å–**ï¼šSession é€šè¿‡ ConnectionManager å¼‚æ­¥è·å–å‘é€äººçš„æ˜µç§°ä¿¡æ¯
6. **ä¸šåŠ¡å¤„ç†**ï¼šMessageHandler ç›´æ¥å¤„ç†ç»“æ„åŒ–æ¶ˆæ¯ï¼Œè·å¾—å®Œæ•´çš„è¯­ä¹‰ä¿¡æ¯
7. **æ—¥å¿—è®°å½•**ï¼šå„å±‚è®°å½•ç›¸åº”çš„å¤„ç†æ—¥å¿—

### å‘é€æµç¨‹

1. **ç»“æ„åŒ–è°ƒç”¨**ï¼šSession é€šè¿‡ sendMessage() æ¥å— SendMessageSegment[] æ ¼å¼æ¶ˆæ¯
2. **å§”æ‰˜è½¬å‘**ï¼šSession å°†ç»“æ„åŒ–æ¶ˆæ¯ç›´æ¥å§”æ‰˜ç»™ ConnectionManager.sendGroupMessage()
3. **è¿æ¥æ£€æŸ¥**ï¼šConnectionManager ç¡®è®¤ WebSocket è¿æ¥çŠ¶æ€
4. **ç›´æ¥å‘é€**ï¼šç»“æ„åŒ–æ¶ˆæ¯ç›´æ¥ç¬¦åˆ napcat API æ ¼å¼ï¼Œæ— éœ€é¢å¤–æ„é€ 
5. **å‘é€è¯·æ±‚**ï¼šè°ƒç”¨ napcat çš„ send_group_msg APIï¼Œæ”¯æŒ @ ç­‰å¤æ‚æ ¼å¼
6. **ç»“æœå¤„ç†**ï¼šå¤„ç†å‘é€ç»“æœå’Œå¯èƒ½çš„é”™è¯¯
7. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ¶ˆæ¯å‘é€æˆåŠŸæˆ–å¤±è´¥æ—¥å¿—

## æ¶ˆæ¯å¤„ç†å›è°ƒè®¾è®¡

### æ•°æ®ç»“æ„

```typescript
import { SendMessageSegment } from "node-napcat-ts";

interface Message {
    id: string;                      // æ¶ˆæ¯ID
    groupId: number;                 // ç¾¤ç»„ID
    userId: number;                  // å‘é€è€…ID
    userNickname?: string;           // å‘é€è€…æ˜µç§°
    content: SendMessageSegment[];   // ç»“æ„åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
    timestamp: Date;                 // æ¥æ”¶æ—¶é—´
}

interface MessageHandler {
    handleMessage(message: Message): Promise<void>;
}

type MessageDispatcher = (context: unknown) => void;  // æ¶ˆæ¯åˆ†å‘å™¨ç±»å‹
```

**é‡å¤§æ¶æ„å‡çº§ï¼ˆ2024å¹´ï¼‰**ï¼š
- **ç»Ÿä¸€æ•°æ®ç»“æ„**ï¼šç§»é™¤äº†å†—ä½™çš„ `mentions` å’Œçº¯æ–‡æœ¬ `content` å­—æ®µ
- **ç»“æ„åŒ–æ¶ˆæ¯**ï¼šä½¿ç”¨ `SendMessageSegment[]` ç»Ÿä¸€å¤„ç†æ¥æ”¶å’Œå‘é€çš„æ¶ˆæ¯
- **å®Œæ•´è¯­ä¹‰ä¿ç•™**ï¼š@ æåŠã€æ–‡æœ¬ç­‰æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ `content` æ•°ç»„ä¸­ç»“æ„åŒ–å­˜å‚¨
- **ç±»å‹å®‰å…¨**ï¼šä¸ node-napcat-ts åº“çš„ç±»å‹ç³»ç»Ÿå®Œå…¨å…¼å®¹

### å›è°ƒæœºåˆ¶

- **åˆ†å‘å™¨æ¨¡å¼**ï¼šConnectionManager é€šè¿‡ MessageDispatcher å°†æ¶ˆæ¯åˆ†å‘ç»™ SessionManager
- **è·¯ç”±æœºåˆ¶**ï¼šSessionManager æ ¹æ® groupId è·¯ç”±åˆ°å¯¹åº” Session
- **å®æ—¶å¤„ç†**ï¼šæ¶ˆæ¯åˆ°è¾¾åç«‹å³è§¦å‘åˆ†å‘å’Œå¤„ç†é“¾
- **å¼‚æ­¥æ”¯æŒ**ï¼šæ”¯æŒå¼‚æ­¥æ¶ˆæ¯å¤„ç†é€»è¾‘
- **é”™è¯¯éš”ç¦»**ï¼šå„å±‚é”™è¯¯å¤„ç†äº’ä¸å½±å“

### @ æ¶ˆæ¯å¤„ç†

- **ç»“æ„åŒ–æ£€æµ‹**ï¼šç›´æ¥ä» `content` æ•°ç»„ä¸­æ£€æµ‹ `at` ç±»å‹æ¶ˆæ¯æ®µ
- **ç²¾ç¡®åŒ¹é…**ï¼šé€šè¿‡éå†æ¶ˆæ¯ç»“æ„æ£€æµ‹æœºå™¨äººæ˜¯å¦è¢« @ æåŠ
- **ç»Ÿä¸€æ˜¾ç¤º**ï¼šæ§åˆ¶å°å’Œ LLM éƒ½èƒ½æ­£ç¡®ç†è§£ @ ä¿¡æ¯çš„å®Œæ•´è¯­ä¹‰

```typescript
// æ–°çš„ @ æ£€æµ‹æœºåˆ¶
private isBotMentioned(message: Message): boolean {
    return message.content.some(item => 
        item.type === "at" && item.data.qq === this.botQQ.toString(),
    );
}
```

## é…ç½®ç®¡ç†

### å±‚æ¬¡ç»“æ„

```yaml
napcat:
  base_url: "ws://localhost:3001"  # WebSocket åœ°å€
  access_token: "token"            # è®¿é—®ä»¤ç‰Œ
  reconnection:                    # é‡è¿é…ç½®
    enable: true
    attempts: 10
    delay: 5000
  bot_qq: 123456789                # æœºå™¨äººQQå·
  groups: [123456, 789012]         # ç›®æ ‡ç¾¤ç»„åˆ—è¡¨

agent:                             # å¯¹è¯é…ç½®ï¼ˆå¯é€‰ï¼‰
  history_turns: 40                # ä¿ç•™å†å²æ¶ˆæ¯æ¡æ•°
```

### é…ç½®éªŒè¯

- å¯åŠ¨æ—¶éªŒè¯å¿…éœ€é…ç½®é¡¹
- ç¼ºå°‘é…ç½®æ—¶æŠ›å‡ºæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- æ”¯æŒç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

### å¯åŠ¨æµç¨‹

1. åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆåŒ…æ‹¬æœºå™¨äººQQå·ï¼‰
2. åˆ›å»º LlmClient å’Œ SessionManager å®ä¾‹
3. SessionManager å†…éƒ¨åˆ›å»º ConnectionManager å¹¶è®¾ç½®æ¶ˆæ¯åˆ†å‘å™¨
4. å»ºç«‹å”¯ä¸€çš„ WebSocket è¿æ¥
5. æ ¹æ®ç¾¤ç»„åˆ—è¡¨åˆ›å»º Session å®ä¾‹
6. ä¸ºæ¯ä¸ª Session è‡ªåŠ¨åˆ›å»º PassiveMessageHandler
7. è®¾ç½®ä¿¡å·å¤„ç†å™¨ç”¨äºä¼˜é›…å…³é—­

### å…³é—­æµç¨‹

1. æ¥æ”¶ SIGINT æˆ– SIGTERM ä¿¡å·
2. è°ƒç”¨ SessionManager çš„å…³é—­æ–¹æ³•
3. å…³é—­å”¯ä¸€çš„ ConnectionManager è¿æ¥
4. æ¸…ç†æ‰€æœ‰ Session å®ä¾‹å’Œèµ„æº
5. ä¼˜é›…é€€å‡ºè¿›ç¨‹

### é”™è¯¯å¤„ç†

- åˆ†å±‚é”™è¯¯éš”ç¦»ï¼šè¿æ¥å±‚ã€åˆ†å‘å±‚ã€ä¸šåŠ¡å±‚é”™è¯¯ç‹¬ç«‹å¤„ç†
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ä¼˜é›…çš„é”™è¯¯æ¢å¤æœºåˆ¶

## æ‰©å±•ç‚¹

### æ¶ˆæ¯å¤„ç†æ‰©å±•

- âœ… å·²å®ç°ï¼šå®Œå…¨ç»“æ„åŒ–çš„æ¶ˆæ¯å¤„ç†æ¶æ„
- âœ… å·²å®ç°ï¼šLLM æ™ºèƒ½å›å¤å’Œè¢«åŠ¨å¯¹è¯åŠŸèƒ½
- âœ… å·²å®ç°ï¼šåŸºäºä¸Šä¸‹æ–‡çš„å¯¹è¯è®°å¿†å’Œå†å²ç®¡ç†
- âœ… å·²å®ç°ï¼š@ æåŠçš„å®Œæ•´è¯­ä¹‰ç†è§£å’Œç”Ÿæˆ
- ğŸ”„ å¾…æ‰©å±•ï¼šå›¾ç‰‡ã€æ–‡ä»¶ç­‰å¯Œåª’ä½“æ¶ˆæ¯ï¼ˆæ¶æ„å·²å°±ç»ªï¼‰
- ğŸ”„ å¾…æ‰©å±•ï¼šè¡¨æƒ…ã€å›å¤å¼•ç”¨ç­‰é«˜çº§æ¶ˆæ¯åŠŸèƒ½
- ğŸ”„ å¾…æ‰©å±•ï¼šæ¶ˆæ¯å†…å®¹çš„é¢„å¤„ç†å’Œè¿‡æ»¤
- ğŸ”„ å¾…æ‰©å±•ï¼šä¸»åŠ¨å¯¹è¯æ¨¡å¼å’Œå®šæ—¶å‘è¨€

### å­˜å‚¨æ‰©å±•

- æ¶ˆæ¯å†å²æŒä¹…åŒ–å­˜å‚¨
- ç”¨æˆ·ç”»åƒå’Œä¸Šä¸‹æ–‡è®°å¿†
- å¯¹è¯å†å²çš„æŸ¥è¯¢å’Œç®¡ç†
- åˆ†å¸ƒå¼å­˜å‚¨æ”¯æŒ

### ç¾¤ç»„ç®¡ç†æ‰©å±•

- åŠ¨æ€æ·»åŠ å’Œåˆ é™¤ç¾¤ç»„
- ç¾¤ç»„ç‰¹å®šçš„é…ç½®å’Œè¡Œä¸º
- ç¾¤ç»„æƒé™å’Œè®¿é—®æ§åˆ¶

### ç›‘æ§æ‰©å±•

- è¿æ¥çŠ¶æ€ç›‘æ§
- æ¶ˆæ¯æ•°é‡ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡é‡‡é›†